"use strict";var updateTitle=function($rootScope,$timeout){return{link:function(scope,element){var listener=function(event,toState){var title="i have a tribe";toState.data&&toState.data.pageTitle&&(title=toState.data.pageTitle),$timeout(function(){element.text(title)})};$rootScope.$on("$stateChangeStart",listener)}}},errSrc=function(){return{link:function(scope,element,attrs){element.bind("error",function(){attrs.src!==attrs.errSrc&&attrs.$set("src",attrs.errSrc)})}}},anchorSmoothScroll=function(){this.scrollTo=function(eID){var currentYPosition=function(){return $(".parallax").scrollTop()},elmYPosition=function(eID){return $("#"+eID).position().top},startY=currentYPosition(),stopY=startY+elmYPosition(eID),distance=stopY>startY?stopY-startY:startY-stopY;if(100>distance)return void $(".parallax").scrollTop(stopY);var speed=Math.round(distance/60);speed>60&&(speed=60);var step=Math.round(distance/25),leapY=stopY>startY?startY+step:startY-step,timer=0;if(stopY>startY)for(var i=startY;stopY>i;i+=step)setTimeout('$(".parallax").scrollTop('+leapY+")",timer*speed),leapY+=step,leapY>stopY&&(leapY=stopY),timer++;else for(var j=startY;j>stopY;j-=step)setTimeout('$(".parallax").scrollTop('+leapY+")",timer*speed),leapY-=step,stopY>leapY&&(leapY=stopY),timer++}},scrollSpy=function(){return{restrict:"A",controller:function($scope){$scope.spies=[],this.addSpy=function(spyObj){$scope.spies.push(spyObj)}},link:function(scope,elem){var spyElems;spyElems=[],scope.$watch("spies",function(spies){var spy,_i,_len,_results;for(_results=[],_i=0,_len=spies.length;_len>_i;_i++)spy=spies[_i],null==spyElems[spy.id]&&_results.push(spyElems[spy.id]=elem.find("#"+spy.id));return _results}),$(".parallax").scroll(function(){var highlightSpy,pos,spy,_i,_len,_ref;for(highlightSpy=null,_ref=scope.spies,_i=0,_len=_ref.length;_len>_i;_i++)spy=_ref[_i],spy.out(),void 0!==spyElems[spy.id].offset()&&(pos=$("#"+spy.id).position().top)<=0&&(spy.pos=pos,null===highlightSpy&&(highlightSpy=spy),highlightSpy.pos<spy.pos&&(highlightSpy=spy));return $(".parallax").scrollTop()+$(window).height()>=$(".parallax")[0].scrollHeight&&(spy.pos=pos,highlightSpy=spy),null!==highlightSpy?highlightSpy["in"]():void 0})}}},spy=function($location,$anchorSmoothScroll){return{restrict:"A",require:"^scrollSpy",link:function(scope,elem,attrs,affix){elem.click(function(){$anchorSmoothScroll.scrollTo(attrs.spyer)}),affix.addSpy({id:attrs.spyer,"in":function(){elem.addClass("active")},out:function(){elem.removeClass("active")}})}}},youtube=function(){return{restrict:"E",scope:{videoid:"@"},template:'<div class="embed-responsive-item"></div>',link:function(scope,element){scope.$watch("videoid",function(newValue,oldValue){return newValue===oldValue?!1:void(void 0==scope.player?(scope.player=new YT.Player(element.children()[0],{playerVars:{autoplay:0,html5:1,theme:"light",modesbranding:0,color:"white",iv_load_policy:3,showinfo:1,controls:1},videoId:scope.videoid}),scope.player.getIframe()):scope.player.cueVideoById(scope.videoid))})}}},dateTimePicker=function(){return{require:"ngModel",restrict:"AE",scope:{},link:function(scope,elem,attrs,ngModel){elem.datetimepicker({format:"DD/MM/YYYY - HH:mm"}),elem.on("dp.change",function(e){scope.$apply(function(){ngModel.$setViewValue(e.currentTarget.value)})}),elem.on("dp.error",function(e){scope.$apply(function(){ngModel.$setViewValue(e.currentTarget.value)})})}}},checkHeight=function($rootScope,$timeout){return{restrict:"AE",link:function(scope,element){$rootScope.$on("$stateChangeSuccess",function(){$timeout(function(){var maxHeight=$(window).height()-20,well=element.find(".well").eq(0);well.css({"max-height":maxHeight,"margin-top":"10px","overflow-y":"auto"}),$(window).resize(function(){var maxHeight=$(window).height()-20;well.css({"max-height":maxHeight})})},50)})}}},authInterceptor=function($rootScope,$q,$window){return{request:function(config){return config.headers=config.headers||{},$window.sessionStorage.token&&(config.headers.Authorization="Bearer "+$window.sessionStorage.token),config},response:function(response){return 401===response.status,response||$q.when(response)}}},globals=function(){var globals={};return globals.serverUrl="http://api.ihaveatribe.com",globals},showsModel=function($http){var model={};return model.getShows=function($scope,url){$http.get(url).success(function(res){if(res.success){$scope.shows=res.shows;for(var i=0;i<$scope.shows.length;i++)$scope.shows[i].when=new Date($scope.shows[i].when),$scope.shows[i].timeString=("00"+$scope.shows[i].when.getHours()).substr(-2)+":"+("00"+$scope.shows[i].when.getMinutes()).substr(-2),$scope.shows[i].dateString=$scope.weekLookup[$scope.shows[i].when.getDay()]+", "+$scope.shows[i].when.getDate()+"/"+($scope.shows[i].when.getMonth()+1)+"/"+$scope.shows[i].when.getFullYear();$scope.error=null}else $scope.error="Website error."}).error(function(){$scope.error="Network connection error."})},model.addShow=function($scope,url){var formData=$.extend(!0,{},$scope.newShow);formData.when=moment(formData.when,"DD/MM/YYYY - HH:mm")._d.toJSON(),$http.post(url,formData).success(function(res){res.success?($scope.broadcast(),$(".modal").modal("hide")):$scope.error="Failed to add new show."}).error(function(){$scope.error="Network connection error."})},model.deleteShow=function($scope,url){$http.post(url,$scope.activeShow).success(function(res){if(res.success){var index=$scope.shows.indexOf($scope.activeShow);index>-1&&($scope.shows.splice(index,1),$scope.activeShow=null,$scope.firstShown>=$scope.shows.length&&$scope.showEarlier())}else $scope.error="Failed to remove show."}).error(function(){$scope.error="Network connection error."})},model.updateImage=function($scope,url){var image=document.getElementById("showImage").files[0],reader=new FileReader;$scope.imageLoading=!0,reader.onloadend=function(e){var upload=e.target.result,formData={image:upload,show:$scope.activeShow};$http.post(url,formData).success(function(res){if($scope.imageLoading=!1,res.success){var show=res.show;show.when=new Date(show.when),show.timeString=("00"+show.when.getHours()).substr(-2)+":"+("00"+show.when.getMinutes()).substr(-2),show.dateString=show.when.getDate()+"/"+(show.when.getMonth()+1)+"/"+show.when.getFullYear();var index=$scope.shows.indexOf($scope.activeShow);index>=0&&($scope.shows[index]=show,$scope.activeShow=show)}}).error(function(){$scope.error="Network connection error.",$scope.imageLoading=!1})},reader.readAsDataURL(image)},model},userModel=function($http){var model={};return model.logIn=function($scope,url){$http.post(url,$scope.logInForm).success(function(res){$scope.logInForm={email:"",password:""},res.success?($scope.user=res.user,$scope.userError=null,window.sessionStorage.token=res.token,$scope.closeModal()):($scope.userError="Log in error.",delete window.sessionStorage.token)}).error(function(){$scope.userError="Network connection error."})},model.logOut=function($scope){$scope.user=null,delete window.sessionStorage.token},model.checkUser=function($scope,url){window.sessionStorage.token?$http.get(url).success(function(res){$scope.user=res.user?res.user:null}).error(function(){$scope.user=null,$scope.userError="Network connection error."}):$scope.user=null},model},videoModel=function($http){var model={};return model.getVideos=function($scope,url){$http.get(url).success(function(res){res.success&&($scope.videos=res.videos,$scope.activeVideo=$scope.videos[0])}).error(function(){})},model.addVideo=function($scope,url){$http.post(url,{videoid:$scope.newVideo}).success(function(res){res.success&&($scope.videos=res.videos,$scope.newVideo="",null==$scope.activeVideo&&($scope.activeVideo=$scope.videos[0]))}).error(function(){})},model.deleteVideo=function($scope,url,video){$http.post(url,video).success(function(res){res.success&&($scope.videos=res.videos)}).error(function(){})},model},MainCtrl=function($window,$rootScope,userModel,globalModel){this.user=null,this.logInForm={email:"",password:""},this.newUser={email:"",password:""},this.serverUrl=globalModel.serverUrl,this.userError=null,this.login=function(){userModel.logIn(this,globalModel.serverUrl+"user/session")},this.logout=function(){userModel.logOut(this)},this.addUser=function(){userModel.addUser(this,globalModel.serverUrl+"user/user")},userModel.checkUser(this,globalModel.serverUrl+"user/status"),this.closeModal=function(){$(".modal").modal("hide")}},HomeCtrl=function(){},VideoCtrl=function(videoModel,globalModel){this.newVideo="",this.activeVideo=null,this.changeVideo=function(video){this.activeVideo=video},this.addVideo=function(){videoModel.addVideo(this,globalModel.serverUrl+"video")},this.deleteVideo=function(video){videoModel.deleteVideo(this,globalModel.serverUrl+"video/delete",video)},videoModel.getVideos(this,globalModel.serverUrl+"video")},ShowsCtrl=function($scope,showsModel,globalModel){var thisScope=this;this.weekLookup={0:"Sunday",1:"Monday",2:"Tuesday",3:"Wednesday",4:"Thursday",5:"Friday",6:"Saturday"},this.shows=[],this.activeShow=null,this.firstShown=0,this.lastShown=4,this.updateActive=function(show){return this.activeShow==show?void(this.activeShow=null):void(this.activeShow=show)},this.showEarlier=function(){return 0==this.firstShown?!1:(this.firstShown-=5,void(this.lastShown-=5))},this.showLater=function(){return this.lastShown>=this.shows.length?!1:(this.firstShown+=5,void(this.lastShown+=5))},this.imageDir=globalModel.serverUrl+"public/images/",showsModel.getShows(this,globalModel.serverUrl+"shows"),$scope.$on("updateShows",function(){showsModel.getShows(thisScope,globalModel.serverUrl+"shows")}),this.deleteShow=function(){showsModel.deleteShow(this,globalModel.serverUrl+"shows/delete")},this.updateImage=function(){showsModel.updateImage(this,globalModel.serverUrl+"shows/image")}},ShowsFormCtrl=function($rootScope,showsModel,globalModel){this.newShow={when:null,venueName:null,eventUrl:null,city:null,address:null,country:null},this.imageDir=globalModel.serverUrl+"public/images/",showsModel.getShows(this,globalModel.serverUrl+"shows"),this.broadcast=function(){$rootScope.$broadcast("updateShows")},this.addShow=function(){var when=moment(this.newShow.when,"DD/MM/YYYY - HH:mm")._d.toJSON();return this.whenError="Invalid Date"==when||null==this.newShow.when?!0:!1,this.cityError=null==this.newShow.city?!0:!1,this.venueError=null==this.newShow.venueName?!0:!1,this.venueError||this.whenError||this.cityError?!1:void showsModel.addShow(this,globalModel.serverUrl+"shows")}},ContactCtrl=function(){};!function(){angular.module("app",["ui.router","ngAnimate"],function($httpProvider){$httpProvider.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded;charset=utf-8",$httpProvider.interceptors.push("authInterceptor");var param=function(obj){var name,value,fullSubName,subName,subValue,innerObj,i,query="";for(name in obj)if(value=obj[name],value instanceof Array)for(i=0;i<value.length;++i)subValue=value[i],fullSubName=name+"["+i+"]",innerObj={},innerObj[fullSubName]=subValue,query+=param(innerObj)+"&";else if(value instanceof Object)for(subName in value)subValue=value[subName],fullSubName=name+"["+subName+"]",innerObj={},innerObj[fullSubName]=subValue,query+=param(innerObj)+"&";else void 0!==value&&null!==value&&(query+=encodeURIComponent(name)+"="+encodeURIComponent(value)+"&");return query.length?query.substr(0,query.length-1):query};$httpProvider.defaults.transformRequest=[function(data){return angular.isObject(data)&&"[object File]"!==String(data)?param(data):data}]});var MainConfig=function($stateProvider,$urlRouterProvider){$urlRouterProvider.otherwise("/"),$stateProvider.state("home",{url:"/",templateUrl:"./templates/home.html"}).state("video",{url:"/video",templateUrl:"./templates/video.html",controller:"VideoCtrl as video"}).state("listen",{url:"/listen",templateUrl:"./templates/listen.html"}).state("shows",{url:"/shows",templateUrl:"./templates/shows.html",controller:"ShowsCtrl as shows"}).state("contact",{url:"/contact",templateUrl:"./templates/contact.html"}).state("social",{url:"/social",templateUrl:"./templates/social.html"})};angular.module("app").service("$anchorSmoothScroll",anchorSmoothScroll).directive("scrollSpy",scrollSpy).directive("spyer",spy).directive("updateTitle",updateTitle).directive("errSrc",errSrc).directive("youtube",youtube).directive("dateTimePicker",dateTimePicker).directive("checkHeight",checkHeight).factory("globalModel",globals).factory("showsModel",showsModel).factory("userModel",userModel).factory("videoModel",videoModel).factory("authInterceptor",authInterceptor).controller("MainCtrl",MainCtrl).controller("HomeCtrl",HomeCtrl).controller("VideoCtrl",VideoCtrl).controller("ShowsCtrl",ShowsCtrl).controller("ShowsFormCtrl",ShowsFormCtrl).controller("ContactCtrl",ContactCtrl).config(MainConfig)}();